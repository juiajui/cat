<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»»å‹™åŠ©æ‰‹</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" onload="console.log('SDK Loaded')" onerror="alert('SDK è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯')"></script>
    
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      // ææ—©åˆå§‹åŒ–
      OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({
          appId: "a7a8a1b0-bca1-4066-8a01-5bcb5ea204cd",
          serviceWorkerPath: 'OneSignalSDKWorker.js',
          allowLocalhostAsSecureOrigin: true
        }).then(() => {
            if(window.log) log("OneSignal åˆå§‹åŒ–å®Œæˆ");
        });
      });
    </script>

    <style>
        body { font-family: -apple-system, sans-serif; padding: 15px; background: #f4f7f9; }
        .container { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-ready { width: 100%; padding: 14px; background: #2ecc71; color: white; border: none; border-radius: 10px; font-weight: bold; margin-bottom: 10px; }
        #debug-log { margin-top: 15px; padding: 10px; background: #1a1a1a; color: #00ff00; font-family: monospace; font-size: 11px; border-radius: 8px; height: 100px; overflow-y: auto; }
        input { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ä»»å‹™ç´€éŒ„åŠ©æ‰‹</h2>
    <button class="btn-ready" onclick="activatePush()">ç¬¬ä¸€æ­¥ï¼šå¼·åˆ¶é€£ç·š</button>
    
    <div class="form-grid">
        <input type="datetime-local" id="startTime">
        <input type="number" id="duration" placeholder="æŒçºŒå°æ™‚ (ä¾‹å¦‚: 2)">
    </div>
    <button id="addBtn" onclick="addTask()" style="width:100%; padding:14px; background:#3498db; color:white; border:none; border-radius:10px; margin-top:10px;">ç¬¬äºŒæ­¥ï¼šé ç´„é€šçŸ¥</button>

    <div id="debug-log">ç³»çµ±æº–å‚™ä¸­...<br></div>
</div>

<script>
    function log(msg) {
        const div = document.getElementById('debug-log');
        div.innerHTML += "> " + msg + "<br>";
        div.scrollTop = div.scrollHeight;
    }

    async function activatePush() {
        log("æŒ‰éˆ•å·²é»æ“Šï¼Œå•Ÿå‹• OneSignalDeferred...");
        
        if (typeof OneSignalDeferred === 'undefined') {
            log("âŒ éŒ¯èª¤ï¼šSDK å°šæœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚");
            return;
        }

        OneSignalDeferred.push(async function(OneSignal) {
            log("é€²å…¥ OneSignal æ ¸å¿ƒ...");
            try {
                log("æ­£åœ¨è«‹æ±‚æ¬Šé™...");
                await OneSignal.Notifications.requestPermission();
                log("æ¬Šé™ç‹€æ…‹: " + OneSignal.Notifications.permission);
                
                let count = 0;
                let timer = setInterval(() => {
                    const userId = OneSignal.User.PushSubscription.id;
                    log("æŠ“å– ID ä¸­... (" + count + ")");
                    if (userId) {
                        clearInterval(timer);
                        log("âœ… æˆåŠŸï¼ID: " + userId);
                        alert("âœ… æˆåŠŸç²å– IDï¼");
                    } else if (count >= 15) {
                        clearInterval(timer);
                        log("âŒ é€¾æ™‚ï¼šè«‹æª¢æŸ¥ OneSignal å¾Œå° Site URL æ˜¯å¦åŒ…å« /cat/");
                    }
                    count++;
                }, 1000);
            } catch (err) {
                log("ğŸš« ç™¼ç”ŸéŒ¯èª¤: " + err);
            }
        });
    }

    async function addTask() {
        // é ç´„é€šçŸ¥é‚è¼¯åŒå‰
        OneSignalDeferred.push(async function(OneSignal) {
            const userId = OneSignal.User.PushSubscription.id;
            if (!userId) { alert("è«‹å…ˆç²å– ID"); return; }
            log("æº–å‚™é ç´„é€šçŸ¥...");
            // ... (å…¶é¤˜ API å‘¼å«ä»£ç¢¼)
        });
    }

    window.onload = function() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('startTime').value = now.toISOString().slice(0,16);
        log("ç³»çµ±åˆå§‹åŒ–å®Œç•¢ã€‚");
    };
</script>
</body>
</html>
